rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin';
    }
    
    function isCustomer() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'customer';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - Admin can access all, users can access their own
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Services collection - Public read access, admin-only write operations
    match /services/{serviceId} {
      allow read: if true; // Allow public read access for guests and authenticated users
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Categories collection - Public read access, admin-only write operations
    match /categories/{categoryId} {
      allow read: if true; // Allow public read access for guests and authenticated users
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Bookings collection - Customers can access their own, admin can access all
    // Customers can also query bookings by date to check availability (for conflict detection)
    match /bookings/{bookingId} {
      // Helper function to check if booking is active (not cancelled)
      // If status field doesn't exist (null), treat as active (default status is 'pending')
      function isActiveBooking() {
        return resource.data.status != 'cancelled';
      }
      
      // Allow customers to read bookings for availability checking (date/time queries)
      // Allow customers to read their own bookings fully
      // Allow admins to read all bookings
      // For queries: Allow any authenticated user to query bookings by date for availability checks
      // Note: In query context, resource.data may not be available, so we need to allow queries
      // The application logic filters out cancelled bookings and sensitive data
      allow read: if isAuthenticated() && (
        isAdmin() || 
        // For individual document reads: check ownership
        (resource.data != null && isOwner(resource.data.customerId)) ||
        // For queries: allow authenticated users to query for availability checking
        // This is needed because resource.data is not available in query context
        // The app filters out cancelled bookings and only uses date/time for conflict detection
        true
      );
      
      // Allow customers to create their own bookings
      // Allow admins to create bookings for any customer
      // Simplified: Allow any authenticated user to create a booking if customerId matches their uid
      // This avoids the need to check role which might fail if user document doesn't exist
      // Primary check: customerId must match authenticated user's uid
      // Secondary check: allow if user is admin (for admin-created bookings)
      allow create: if isAuthenticated() && (
        request.auth.uid == request.resource.data.customerId ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin')
      );
      
      // Allow customers to update/cancel their own bookings
      // Allow admins to update any booking
      allow update: if isAuthenticated() && (
        isAdmin() || 
        (isOwner(resource.data.customerId) && request.resource.data.customerId == resource.data.customerId)
      );
      
      // Allow customers to delete their own bookings (cancellation)
      // Allow admins to delete any booking
      allow delete: if isAuthenticated() && (
        isAdmin() || 
        isOwner(resource.data.customerId)
      );
    }
    
           // Reviews collection - Customers can access their own, admin can access all
           match /reviews/{reviewId} {
             allow read: if isAuthenticated();
             allow write: if isOwner(resource.data.userId) || isAdmin();
             allow create: if isCustomer() && request.auth.uid == request.resource.data.userId;
           }

    // Salon Hours collection - Public read access for booking availability, admin-only write operations
    match /salonHours/{hoursId} {
      allow read: if true; // Allow public read access for customers to check availability
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }

    // Salon Settings collection - Public read access for default schedule, admin-only write operations
    match /salonSettings/{settingsId} {
      allow read: if true; // Allow public read access for default schedule
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}